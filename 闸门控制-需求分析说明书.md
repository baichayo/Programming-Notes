# 需求分析说明书-闸门控制

## 灯

### 模式

- 常亮绿灯
- 常亮红灯
- 闪红灯
- 闪绿灯

### 功能

很明显灯亮的模式取决于外部状态，**闸的分合** 和 **报警（保护）** ，那么就有两种设计

- 当前模块定时监听状态，决定亮灯模式
  - 模块间耦合度低
  - 外部模块需维护好状态
  - 需要时刻监听，浪费性能
- 交由其他模块调用
  - 由事件驱动
  - 亮灯模块成为其他模块的子模块，耦合度高，可能造成其他模块设计过大

#### 电压过高（或过低）

- **若合闸状态：**闪红灯
- **若分闸状态：**闪绿灯

#### 电压正常

- **若合闸状态：**常亮红灯
- **若分闸状态：**常亮绿灯



思考：触发电压保护后会自动分闸，那么会有合闸状态吗？

- 电压异常中，人为合闸
  - 按键：按键后可以检测状态，若异常则不合闸
  - 手柄：好像没办法阻止合闸



## 电压报警和保护

电压报警和保护并不是等同的状态，差异表现为报警不会拉闸。

- 但在考虑灯的状态时，应该是可以视为一样的

定时采集电压，需要用到：

- 定时器
- ADC
- 算法

### 功能

- 电压报警只需控制灯模式，简单

- 电压保护最终是为了分闸，但闸门状态影响因素过多，得综合判断，因此只能交由其他模块负责
- 但能否有这种设计，我直接武断拉闸，并设置当前模块的闸门状态 `volt_prot_switch` ，最终是否拉闸成功，由闸门模块判断
  - 一定程度上能够解耦
  - 但引入了额外的状态，好像逻辑更复杂了

![](imgs\switch control - 自恢复式过欠压保护器.png)

![9e87a8248c90b9e69e3570522376772](imgs\switch control - 动作时间.png)

![4064c41f7899b37cbec24e33a24e002](imgs\switch control - 动作特性.png)



## 电压恢复

当电压恢复正常后，尝试合闸。但请注意，只有在自动分闸后才会尝试合闸，若手动分闸，则不进行动作。

需要增加四个引脚，改变一个引脚的使用方法。

- 开关，增加 `PA4`
- 漏电检测，增加 `PA0 PA1 PA2` 
- 更改 `PA6`

过欠电压的标准并不一样，所以分开写

- 对于过电压：
  - 不同分级的策略不同，所以每个分级包装一下
  - 每个分级包括：过电压值，动作最短时间，动作最长时间，恢复最短时间，恢复最长时间
  - 应当记录一下当前是哪一级
- 对于欠电压：
  - 没分级
  - 同样包括：欠电压值，动作最短时间，动作最长时间，恢复电压值，恢复最短时间，恢复最长时间





### 电压报警检测策略

- 策略一：100 ms 采样一次，当第一次采样到异常值时开始计时，周期结束后，若异常值次数大于一定值，则分闸。
  - 优点：没有强制地将时间分割
  - 缺点：增加程序复杂度，优点也并不明显
- 策略二：直接分割时间，周期时间内异常值次数大于一定值，则分闸。
  - 优点：简单
  - 缺点：人为分割时间，精确度不高





## 闸门

闸门的状态有三种改变方式，**按键** 、**手柄** 和 **电压保护**

### 按键

- **按上键：**启动漏电保护，分闸（之后尝试自动合闸）
- **按下键：**改变当前闸门状态，若合则分，若分则合

### 手柄

- **上推合闸：**不知道归不归我管

- **下拉分闸：**不知道归不归我管

### 电压保护

- **电压正常：**尝试合闸
- **电压异常：**分闸



### 功能分析

可以看出，闸门的状态受多种因素影响，当多种因素同时发生时，势必会产生冲突。需要管理好状态迁移。

目前采用**其他模块只产生信号，动作全交由闸门模块实现**的模式。

<img src="imgs\switch control - 状态机.png" style="zoom: 67%;" />

从上图可以看出主要的状态转移，概率事件，如 按键/推闸 的同时 电压异常 暂不考虑。
