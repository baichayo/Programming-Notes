# 闸门控制 -概要设计

## 引脚说明

- 亮灯，需要两个引脚 白高黑低
- ADC 采集，需要一个引脚，PB5
- 报警（保护），需要一个标志位，应该不需要引脚
- 通用定时器
- 电机，两个引脚
- 分合闸，三个引脚



假设分合闸的功能已经实现，那么剩下的就是设计状态

- **按上键：**启动漏电保护，分闸（之后尝试自动合闸）
- **按下键：**改变当前闸门状态，若合则分，若分则合
- **电压正常：**尝试合闸
- **电压异常：**分闸
- **上推合闸：**
- **下拉分闸：**





## light.h

- 亮灯模式只取决于 闸门状态 和 电压状态，`light.c` 只读状态，并不做更改
- 为了防止亮灯模块更改 闸门状态 和 电压状态，应该 只提供 `get` 接口，而不是直接访问状态变量



### light_ctrl()

- 获取 **闸门状态** 和 **电压状态** 来选择亮灯模式
- 在定时器中每 `10ms` 被调用一次，意味着灯的模式切换最多延迟 `10ms`

### steady_green_light()

- 红灭绿亮

### steady_red_light()

- 绿灭红亮

### flash_green_light()

- 周期为 `500 ms`，亮 `250ms` ,灭 `250ms`

### flash_red_light()



### light_init()

- `PB1` green `PB2` red
- CMOS输出模式，高驱动







## motor.h

### motorWaitSwitch

需要让电机跑一圈，并在跑一圈的过程中，若已经碰到开关，则停止

- 为了让电机跑一圈并随时检测开关，那么就需要先 `while(1)` ，然后两个条件跳出循环
  - 超时
  - 碰到开关
- 所以我需要一个能够获取当前时间的api



### motorSet

### motor_get_motor_state 

- 提供给 `air_switch` 模块访问电机状态的接口

### motorSet

- 控制电机正转、反转和停止

### motorWaitSwitch

- 分合闸时，电机正转后的工作逻辑
- 保证转一圈，碰到开关提前停止

### t_switch_init

- 配置微动开关（1 和 2）和下端检测 的引脚
- 输入 上拉

### motor_init

- 配置电机的引脚
- `PA4 FI  PA5 BI`
- CMOS 输出 高驱动



- 微动开关3 的引脚在哪
- 为什么微动开关3 的电平代表了闸门的状态
- 为什么碰到微动开关1就会合闸，是硬件做到的吗



## air_switch.h

闸门当前的状态可以由 下端检测（我也不知道是啥）知道，我只需要检测与 下端检测 绑定的引脚即可

- 那么我好像发现了新东西，既然有个引脚关联到了闸门的状态，
  - 那么我给这个引脚设置个中断，闸门状态的维护就能用事件驱动
  - 电压得不断检测，但我也可以手写实现检测电压状态改变事件
  - 那么综合两个事件驱动，亮灯模式也能实现事件驱动了，不过闪灯还是需要定时调用

- 以上好像是假的，因为 下端检测 只是在分合闸一瞬间电平变低，而不是代表着闸门状态。
- 并且带来一个问题，如何判断当前闸门状态呢？
  - 写个系统初始化函数，将闸门分闸



### air_sw_close

- 分闸时调用

### air_sw_open

- 合闸时调用



### air_sw_open_close

- 提供给外部的接口，改变闸门状态

### set_air_sw_status

- 维护闸门状态，AC检测中断时调用

### get_air_sw_status

- 提供给外部接口，获取闸门状态



负责分合闸，那么状态就在这维护

- 闸门状态可能会由三个因素改变，电压，按键和手柄。
- 每个模块达到各自的条件后都会分合闸，如果交由他们维护状态，未免有些麻烦，甚至可能冲突
- 因此我将状态的改变放在分合闸当中，其他模块可以通过读取状态来判断是否分合闸成功



## switch_key.h

此模块的逻辑是，外部按键按下后，实行分合闸

- 那么需要检测引脚电平，可以用
  - 定时器，每 10 ms 检测一次引脚
  - IO change 中断（目前用这个）
- 现在问题是，按键和下端检测都会触发中断，那么中断函数可以写在各自的文件里吗
  - 任何一个按键都会触发中断
  - 按键要不要防抖

### switch_keys_init

- 漏电检测键和闸门键引脚配置
- `PA6` 漏电检测 分闸
- `PB0` 改变闸门状态 分合闸
- 输入 引脚唤醒 上拉
- 中断检测会执行相应逻辑



## voltage_alarm.h

adc采样，之后算出电压，维护电压状态。



